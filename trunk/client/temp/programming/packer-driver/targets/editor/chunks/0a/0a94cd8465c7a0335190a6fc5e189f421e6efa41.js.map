{"version":3,"sources":["file:///F:/TON-Game/src/trunk/client/extensions/oops-plugin-framework/assets/core/Root.ts"],"names":["_decorator","Component","director","Game","game","JsonAsset","Node","screen","sys","GameConfig","GameQueryConfig","oops","version","AudioManager","EventMessage","message","resLoader","StorageManager","TimerManager","GameManager","LayerManager","property","isInited","Root","type","tooltip","persist","onLoad","console","log","enabled","loadConfig","then","addPersistRootNode","res","config_name","config","loadAsync","query","storage","init","localDataKey","localDataIv","audio","addComponent","load","timer","gui","http","server","httpServer","timeout","httpTimeout","frameRate","run","release","update","dt","ecs","execute","initGui","initEcsSystem","on","EVENT_SHOW","onShow","EVENT_HIDE","onHide","isMobile","dispatchEvent","GAME_RESIZE","GAME_FULL_SCREEN","GAME_ORIENTATION","resumeAll","resume","GAME_SHOW","save","pauseAll","pause","GAME_HIDE"],"mappings":"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","sourcesContent":["/*\r\n * @Author: dgflash\r\n * @Date: 2021-07-03 16:13:17\r\n * @LastEditors: dgflash\r\n * @LastEditTime: 2023-08-28 10:02:57\r\n */\r\nimport { _decorator, Component, director, Game, game, JsonAsset, Node, screen, sys } from \"cc\";\r\nimport { GameConfig } from \"../module/config/GameConfig\";\r\nimport { GameQueryConfig } from \"../module/config/GameQueryConfig\";\r\nimport { oops, version } from \"./Oops\";\r\nimport { AudioManager } from \"./common/audio/AudioManager\";\r\nimport { EventMessage } from \"./common/event/EventMessage\";\r\nimport { message } from \"./common/event/MessageManager\";\r\nimport { resLoader } from \"./common/loader/ResLoader\";\r\nimport { StorageManager } from \"./common/storage/StorageManager\";\r\nimport { TimerManager } from \"./common/timer/TimerManager\";\r\nimport { GameManager } from \"./game/GameManager\";\r\nimport { GUI } from \"./gui/GUI\";\r\nimport { LayerManager } from \"./gui/layer/LayerManager\";\r\n\r\nconst { property } = _decorator;\r\n\r\nlet isInited = false;\r\n\r\n/** 框架显示层根节点 */\r\nexport class Root extends Component {\r\n    /** 游戏层节点 */\r\n    @property({\r\n        type: Node,\r\n        tooltip: \"游戏层\"\r\n    })\r\n    game: Node = null!;            // 可使用多摄像机自定义二维或三维游戏场景\r\n\r\n    /** 界面层节点 */\r\n    @property({\r\n        type: Node,\r\n        tooltip: \"界面层\"\r\n    })\r\n    gui: Node = null!;\r\n\r\n    /** 框架常驻节点 */\r\n    private persist: Node = null!\r\n\r\n    onLoad() {\r\n        if (!isInited) {\r\n            isInited = true;      // 注：这里是规避cc3.8在编辑器模式下运行时，关闭游戏会两次初始化报错\r\n\r\n            console.log(`Oops Framework v${version}`);\r\n            this.enabled = false;\r\n            this.loadConfig().then();\r\n        }\r\n    }\r\n\r\n    private async loadConfig() {\r\n        // 创建持久根节点\r\n        this.persist = new Node(\"OopsFrameworkPersistNode\");\r\n        director.addPersistRootNode(this.persist);\r\n\r\n        // 资源管理模块\r\n        oops.res = resLoader;\r\n\r\n        const config_name = \"config\";\r\n        const config = await oops.res.loadAsync(config_name, JsonAsset);\r\n        if (config) {\r\n            // oops.config.btc = new BuildTimeConstants();\r\n            oops.config.query = new GameQueryConfig();\r\n            oops.config.game = new GameConfig(config);\r\n\r\n            // 本地存储模块\r\n            oops.storage = new StorageManager();\r\n            oops.storage.init(oops.config.game.localDataKey, oops.config.game.localDataIv);      // 初始化本地存储加密\r\n\r\n            // 全局消息\r\n            oops.message = message;\r\n\r\n            // 创建音频模块\r\n            oops.audio = this.persist.addComponent(AudioManager);\r\n            oops.audio.load();\r\n\r\n            // 创建时间模块\r\n            oops.timer = this.persist.addComponent(TimerManager)!;\r\n\r\n            // 游戏场景管理\r\n            oops.game = new GameManager(this.game);\r\n\r\n            // 游戏界面管理\r\n            oops.gui = new LayerManager(this.gui);\r\n\r\n            // 网络模块\r\n            oops.http.server = oops.config.game.httpServer;                                      // Http 服务器地址\r\n            oops.http.timeout = oops.config.game.httpTimeout;                                    // Http 请求超时时间\r\n\r\n            game.frameRate = oops.config.game.frameRate;                                         // 初始化每秒传输帧数\r\n\r\n            this.enabled = true;\r\n            this.init();\r\n            this.run();\r\n\r\n            oops.res.release(config_name);\r\n        }\r\n        else {\r\n            this.loadConfig().then();\r\n        }\r\n    }\r\n\r\n    update(dt: number) {\r\n        oops.ecs.execute(dt);\r\n    }\r\n\r\n    /** 初始化游戏界面 */\r\n    protected initGui() {\r\n\r\n    }\r\n\r\n    /** 初始化游戏业务模块 */\r\n    protected initEcsSystem() {\r\n\r\n    }\r\n\r\n    /** 加载完引擎配置文件后执行 */\r\n    protected run() {\r\n\r\n    }\r\n\r\n    private init() {\r\n        this.initGui();\r\n        this.initEcsSystem();\r\n        oops.ecs.init();\r\n\r\n        // 游戏显示事件\r\n        game.on(Game.EVENT_SHOW, this.onShow, this);\r\n        // 游戏隐藏事件\r\n        game.on(Game.EVENT_HIDE, this.onHide, this);\r\n\r\n        // 添加游戏界面屏幕自适应管理组件\r\n        //this.gui.addComponent(GUI);\r\n\r\n        // 游戏尺寸修改事件\r\n        if (!sys.isMobile) {\r\n            screen.on(\"window-resize\", () => {\r\n                oops.message.dispatchEvent(EventMessage.GAME_RESIZE);\r\n            }, this);\r\n\r\n            screen.on(\"fullscreen-change\", () => {\r\n                oops.message.dispatchEvent(EventMessage.GAME_FULL_SCREEN);\r\n            }, this);\r\n        }\r\n\r\n        screen.on(\"orientation-change\", () => {\r\n            oops.message.dispatchEvent(EventMessage.GAME_ORIENTATION);\r\n        }, this);\r\n    }\r\n\r\n    private onShow() {\r\n        oops.timer.load();              // 处理回到游戏时减去逝去时间\r\n        oops.audio.resumeAll();         // 恢复所有暂停的音乐播放\r\n        director.resume();              // 恢复暂停场景的游戏逻辑，如果当前场景没有暂停将没任何事情发生\r\n        game.resume();                  // 恢复游戏主循环。包含：游戏逻辑，渲染，事件处理，背景音乐和所有音效\r\n        oops.message.dispatchEvent(EventMessage.GAME_SHOW);\r\n    }\r\n\r\n    private onHide() {\r\n        oops.timer.save();             // 处理切到后台后记录切出时间\r\n        oops.audio.pauseAll();         // 暂停所有音乐播放\r\n        director.pause();              // 暂停正在运行的场景，该暂停只会停止游戏逻辑执行，但是不会停止渲染和 UI 响应。 如果想要更彻底得暂停游戏，包含渲染，音频和事件\r\n        game.pause();                  // 暂停游戏主循环。包含：游戏逻辑、渲染、输入事件派发（Web 和小游戏平台除外）\r\n        oops.message.dispatchEvent(EventMessage.GAME_HIDE);\r\n    }\r\n}"]}