{"version":3,"sources":["file:///F:/TON-Game/src/trunk/client/assets/scripts/tongame/liwu/LiWuManager.ts"],"names":["LiwuInfo","LiWuManager","Vec3","UITransform","view","tween","UtilMgr","HeChengComponent","HeChengMgr","GridComponent","BoardMgr","oops","UIID","JsonUtil","TonGameMgr","LayerType","GameEvent","TableGiftBox","TableIngredients","DAILY_REWARD_DATA","constructor","node","IsFlying","LiwuNode","LiwuList","_tsGiftBox","LiWuPassTime","UpdateLiWu","HechengGUI","gui","get","MainUI","hasUI","PopUp","Dialog","init","CanTingLevel","time","getDailyLiWu","numlimit","GenLiWu","HechengCom","getComponent","isHasEmptyGrid","LiwuIdList","index","board","length","cell","SuCaiId","IsLiWu","push","LiwuIndex","getRandomNumber","gridNode","getGridNode","liwu","createLiwu","screenSize","getVisibleSize","setPosition","width","size","x","height","y","liwuInfo","FlyToPos","targetIndex","TargetPos","getPositionInParent","IsLiWuFlying","speed","pos","position","distance","moveDuration","to","call","destroy","message","dispatchEvent","UpdateBaseData","UpdateBoardGrid","Save","start","liwuNode","GridNode","tablePos","worldPos","parent","convertToWorldSpaceAR","convertToNodeSpaceAR","openLiwu","IngredientsId","RankdomDishByCanTingLv","gridComponent","addNodeAnimation","LiwuSprite","PlaySoundEffect","IsAutoOpenLiwu","active","SetImage","level","resultIndex","foodlevel","foodlevel1","probably","probably1","totalNum","i","randNum","Math","floor","random","resultLevel","resultIngredients","jsonIngredients","TableName","id","Ingredients","Number","getTodayDate","today","timer","getServerDate","getFullYear","getMonth","getDate","savedData","storage","data","JSON","parse","date","count","set","stringify","GiftNum","LiWuMgr"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node, EventTouch, Vec3, Sprite, Vec2, UITransform, view, tween, math } from 'cc';\r\n\r\nimport { UtilMgr } from \"../manager/UtilManager\";\r\nimport { HeChengComponent } from \"../hecheng/HeChengComponent\";\r\nimport { HeChengMgr } from '../hecheng/HeChengManager';\r\nimport { GridComponent } from \"../hecheng/GridComponent\";\r\nimport { BoardMgr} from '../manager/BoardManager';\r\nimport { oops } from \"../../../../extensions/oops-plugin-framework/assets/core/Oops\";\r\nimport { UIID } from \"../../framework/common/config/GameUIConfig\";\r\nimport { JsonUtil } from \"../../../../extensions/oops-plugin-framework/assets/core/utils/JsonUtil\";\r\n\r\nimport { TonGameMgr } from \"../manager/TonGameManager\";\r\nimport { LayerType } from \"../../../../extensions/oops-plugin-framework/assets/core/gui/layer/LayerManager\";\r\nimport { GameEvent } from \"../../framework/common/config/GameEvent\";\r\n\r\nimport { TableGiftBox } from \"../../framework/common/table/TableGiftBox\";\r\nimport { TableIngredients } from \"../../framework/common/table/TableIngredients\";\r\n\r\nconst DAILY_REWARD_DATA = \"dailyRewardData\";\r\n\r\nexport class LiwuInfo {\r\n    IsFlying : boolean = false;\r\n    LiwuNode : Node = null;\r\n    constructor(node:Node) {\r\n        this.LiwuNode = node;\r\n      }\r\n}\r\n\r\nexport class LiWuManager {\r\n    public LiwuList: LiwuInfo[] = [];\r\n\r\n    private _tsGiftBox = new TableGiftBox();\r\n    private LiWuPassTime : number = 0;\r\n\r\n    //每5秒执行一次\r\n    public UpdateLiWu() {\r\n        this.LiWuPassTime = this.LiWuPassTime + 5;\r\n        const HechengGUI = oops.gui.get(UIID.MainUI);\r\n        if (HechengGUI) \r\n        {\r\n            if (!oops.gui.hasUI(LayerType.PopUp) && !oops.gui.hasUI(LayerType.Dialog))\r\n            {\r\n                this._tsGiftBox.init(TonGameMgr.CanTingLevel);\r\n                if (this.LiWuPassTime > this._tsGiftBox.time)\r\n                {\r\n                    this.LiWuPassTime = 0;\r\n                    this.getDailyLiWu(this._tsGiftBox.numlimit);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    /* 生成礼物 */\r\n    private GenLiWu() :boolean {\r\n        const HechengGUI = oops.gui.get(UIID.MainUI);\r\n        if (HechengGUI) \r\n        {\r\n            const HechengCom = HechengGUI.getComponent(HeChengComponent);\r\n            if (HechengCom && BoardMgr.isHasEmptyGrid()) \r\n            {\r\n                let LiwuIdList : number[] = [];\r\n                for (let index = 0; index < BoardMgr.board.length; index++) {\r\n                    const cell = BoardMgr.board[index];\r\n                    if (cell.SuCaiId == 0 && !cell.IsLiWu)\r\n                    {\r\n                        LiwuIdList.push(index);\r\n                    }\r\n                }\r\n                let LiwuIndex = UtilMgr.getRandomNumber(LiwuIdList);\r\n                let gridNode = HechengCom.getGridNode(LiwuIndex);\r\n                if (gridNode)\r\n                {\r\n                    let liwu = HechengCom.createLiwu();\r\n                    // 获取屏幕的大小\r\n                    const screenSize = view.getVisibleSize();\r\n                    // 设置节点的位置到屏幕左下角\r\n                    liwu.setPosition(-screenSize.width / 2 + liwu.size.x/2, -screenSize.height / 2 + liwu.size.y/2);\r\n    \r\n                    let liwuInfo = new LiwuInfo(liwu);\r\n                    this.LiwuList.push(liwuInfo);\r\n                    \r\n                    this.FlyToPos(liwuInfo, gridNode, LiwuIndex);\r\n                    return true;\r\n                }\r\n            }\r\n        }\r\n        return false;\r\n    }\r\n\r\n    public FlyToPos(liwuInfo:LiwuInfo, gridNode: Node, targetIndex: number) {\r\n        if (liwuInfo && liwuInfo.LiwuNode) {\r\n            let TargetPos = this.getPositionInParent(liwuInfo.LiwuNode, gridNode);\r\n            BoardMgr.board[targetIndex].IsLiWu = true;\r\n            BoardMgr.board[targetIndex].IsLiWuFlying = true;\r\n\r\n            let speed = 200;\r\n            let pos = liwuInfo.LiwuNode.position;\r\n\r\n            let distance = Vec3.distance(pos, TargetPos);\r\n\r\n            const moveDuration = distance/speed;\r\n\r\n            tween(liwuInfo.LiwuNode)\r\n                .to(moveDuration, { position: TargetPos })\r\n                .call(() => {\r\n                    BoardMgr.board[targetIndex].IsLiWuFlying = false;\r\n                    liwuInfo.LiwuNode.destroy();\r\n                    oops.message.dispatchEvent(GameEvent.UpdateBaseData);\r\n                    oops.message.dispatchEvent(GameEvent.UpdateBoardGrid);\r\n                    oops.message.dispatchEvent(GameEvent.Save);\r\n                })\r\n                .start();\r\n        }\r\n    }\r\n\r\n\r\n\r\n    public getPositionInParent(liwuNode: Node, GridNode: Node): Vec3 {\r\n        let tablePos = new Vec3(GridNode.position.x, GridNode.position.y);\r\n        \r\n        const worldPos = GridNode.parent.getComponent(UITransform).convertToWorldSpaceAR(tablePos);\r\n        return liwuNode.parent.getComponent(UITransform).convertToNodeSpaceAR(worldPos);\r\n    }\r\n    //打开礼物获得素材\r\n    public openLiwu (index:number) {\r\n        if (BoardMgr.board[index].IsLiWu && !BoardMgr.board[index].IsLiWuFlying)\r\n        {\r\n            let IngredientsId = this.RankdomDishByCanTingLv(TonGameMgr.CanTingLevel);\r\n            if (IngredientsId > 0)\r\n            {\r\n                const HechengGUI = oops.gui.get(UIID.MainUI);\r\n                if (HechengGUI) \r\n                {\r\n                    const HechengCom = HechengGUI.getComponent(HeChengComponent);\r\n                    if (HechengCom) \r\n                    {\r\n                        let gridNode = HechengCom.getGridNode(index);\r\n                        if (gridNode)\r\n                        {\r\n                            const gridComponent = gridNode.getComponent(GridComponent);\r\n                            if (gridComponent) \r\n                            {\r\n                                UtilMgr.addNodeAnimation(\"animation/libao\", gridComponent.LiwuSprite.node, true, false, () => {\r\n                                    UtilMgr.PlaySoundEffect(28);\r\n                                    HeChengMgr.IsAutoOpenLiwu = false;\r\n                                    gridComponent.LiwuSprite.node.active = false;\r\n                                    BoardMgr.board[index].SuCaiId = IngredientsId;\r\n                                    BoardMgr.board[index].IsLiWu = false;\r\n                                    BoardMgr.board[index].IsLiWuFlying = false;\r\n                                    oops.message.dispatchEvent(GameEvent.UpdateBaseData);\r\n                                    oops.message.dispatchEvent(GameEvent.UpdateBoardGrid);\r\n                                    oops.message.dispatchEvent(GameEvent.Save);\r\n                                    UtilMgr.SetImage(gridComponent.LiwuSprite, \"textures/UI/baluobo/baluobo;liwu\");\r\n                                });\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n\r\n            }\r\n        }\r\n    }\r\n\r\n    // 根据餐厅等级随机一个菜品\r\n    public RankdomDishByCanTingLv(level : number) : number {\r\n        let resultIndex = 0;\r\n        this._tsGiftBox.init(level);\r\n        let foodlevel = this._tsGiftBox.foodlevel1;\r\n        let probably = this._tsGiftBox.probably1;\r\n        let totalNum = 0;\r\n        for (let i = 0; i < probably.length; i++) {\r\n            totalNum = totalNum + probably[i];\r\n        }\r\n        let randNum = Math.floor(Math.random() * totalNum);\r\n        totalNum = 0\r\n        for (let i = 0; i < probably.length; i++) {\r\n            totalNum = totalNum + probably[i];\r\n            if (randNum < totalNum)\r\n            {\r\n                resultIndex = i;\r\n                break;\r\n            }\r\n        }\r\n        let resultLevel = foodlevel[resultIndex];\r\n        let resultIngredients : number[] = [];\r\n        let jsonIngredients = JsonUtil.get(TableIngredients.TableName);\r\n        if (jsonIngredients) {\r\n            for (let id in jsonIngredients) {\r\n                let Ingredients = jsonIngredients[id];\r\n                if (Ingredients.level == resultLevel) {\r\n                    resultIngredients.push(Number(id));\r\n                }\r\n            }\r\n\r\n            let IngredientsId = UtilMgr.getRandomNumber(resultIngredients);\r\n            return IngredientsId;\r\n        }\r\n        return 0;\r\n    }\r\n\r\n    public getTodayDate(): string {\r\n        const today = oops.timer.getServerDate();\r\n        return `${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`;\r\n    }\r\n\r\n    public getDailyLiWu(numlimit:number) {\r\n        const savedData = oops.storage.get(DAILY_REWARD_DATA);\r\n        let data = savedData ? JSON.parse(savedData) : { date: this.getTodayDate(), count: 0 };\r\n    \r\n        // 如果存储的日期不是今天，重置次数\r\n        if (data.date !== this.getTodayDate()) {\r\n            data.date = this.getTodayDate();\r\n            data.count = 0;\r\n        }\r\n    \r\n        // 检查是否达到每日上限\r\n        if (data.count < numlimit) {\r\n\r\n            if (this.GenLiWu())\r\n            {\r\n                // 生成礼物\r\n                data.count += 1;\r\n                oops.storage.set(DAILY_REWARD_DATA, JSON.stringify(data));\r\n            }\r\n        }\r\n        else\r\n        {\r\n            if (TonGameMgr.GiftNum > 0)\r\n            {\r\n                if (this.GenLiWu())\r\n                {\r\n                    TonGameMgr.GiftNum -= 1;\r\n                    oops.message.dispatchEvent(GameEvent.Save);\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\nexport var LiWuMgr = new LiWuManager();"]}