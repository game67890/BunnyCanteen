{"version":3,"sources":["file:///F:/TON-Game/src/trunk/client/assets/scripts/tongame/manager/BoardManager.ts"],"names":["BoardCell","TouchItem","BoardManager","oops","GameEvent","HeChengMgr","TableIngredients","UtilMgr","GAME_Board_KEY","GAME_GRID_SIZE","constructor","row","col","SuCaiId","IsLiWu","Position","IsLiWuFlying","src","dest","SrcIndex","DestIndex","board","save_data","touchItemList","InDragIndex","IsHuiShou","_tsIngredients","customSort","a","b","init","aLevel","level","bLevel","addTouchItem","push","removeTouchItem","index","length","item","splice","getTouchItem","addGrid","cell","isHasEmptyGrid","isHasSuCai","GetUniqueSuCaiList","uniqueIds","Set","SuCaiList","has","add","sortGrid","sort","getBoardListString","JSON","stringify","save","boardJson","storage","set","load","serverData","loadFromServer","message","on","OnGridContract","onUpdateData","setDataDefault","parse","boardData","setData","e","loadFromLocal","getJson","console","log","map","dispatchEvent","UpdateBoardGrid","event","args","HandleHecheng","SwapGrid","TempASuCaiId","TempBSuCaiId","TempAIsLiwu","TempBIsLiwu","PlaySoundEffect","Save","BoardMgr"],"mappings":"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","sourcesContent":["import { oops } from \"../../../../extensions/oops-plugin-framework/assets/core/Oops\";\r\nimport { GameEvent } from \"../../framework/common/config/GameEvent\";\r\nimport { HeChengMgr } from \"../hecheng/HeChengManager\";\r\n\r\nimport { TableIngredients } from \"../../framework/common/table/TableIngredients\";\r\nimport { UtilMgr } from \"./UtilManager\";\r\n\r\n\r\nconst GAME_Board_KEY = \"ton_board\";\r\nexport const GAME_GRID_SIZE: number = 4; // 棋盘的大小\r\n\r\nexport class BoardCell {\r\n    SuCaiId: number = 0;\r\n    Position: { row: number, col: number };\r\n    IsLiWu : boolean = false;\r\n    IsLiWuFlying : boolean = false;\r\n  \r\n    constructor(row: number, col: number, SuCaiId: number, IsLiWu: boolean) {\r\n      this.SuCaiId = SuCaiId;\r\n      this.Position = { row, col };\r\n      this.IsLiWu = IsLiWu;\r\n      this.IsLiWuFlying = false;\r\n    }\r\n}\r\n\r\nexport class TouchItem {\r\n    SrcIndex : number = 0;\r\n    DestIndex : number = 0;\r\n\r\n    constructor(src: number, dest: number) {\r\n        this.SrcIndex = src;\r\n        this.DestIndex = dest;\r\n    }\r\n}\r\n\r\n  \r\nexport class BoardManager {\r\n    public board: BoardCell[] = [];\r\n    private save_data: any = {};\r\n\r\n    public touchItemList: TouchItem[] = [];\r\n    \r\n    public InDragIndex : number = 0;\r\n    public IsHuiShou : boolean = false;\r\n\r\n    private _tsIngredients = new TableIngredients();\r\n\r\n    public addTouchItem (SrcIndex:number, DestIndex:number) {\r\n        this.touchItemList.push(new TouchItem(SrcIndex, DestIndex));\r\n    }\r\n\r\n    public removeTouchItem (SrcIndex:number, DestIndex:number) {\r\n        for (let index = 0; index < this.touchItemList.length; index++) {\r\n            const item = this.touchItemList[index];\r\n            if (item.SrcIndex == SrcIndex && item.DestIndex == DestIndex)\r\n            {\r\n                this.touchItemList.splice(index, 1); // 删除当前元素\r\n                break;\r\n            }\r\n        }\r\n    }\r\n\r\n    public getTouchItem (SrcIndex:number) : number {\r\n        for (let index = this.touchItemList.length - 1; index >= 0; --index) {\r\n            const item = this.touchItemList[index];\r\n            if (item.SrcIndex == SrcIndex)\r\n            {\r\n               return item.DestIndex;\r\n            }\r\n        }\r\n        return -1;\r\n    }\r\n\r\n    //找到空余格子，添加素材\r\n    public addGrid(SuCaiId: number) : boolean {\r\n        for (let index = 0; index < this.board.length; index++) {\r\n            const cell = this.board[index];\r\n            if (cell.SuCaiId == 0 && !cell.IsLiWu)\r\n            {\r\n                cell.SuCaiId = SuCaiId;\r\n                return true;\r\n            }\r\n        }\r\n        return false;\r\n    }\r\n    //是否还有空位置\r\n    public isHasEmptyGrid() : boolean {\r\n        for (let index = 0; index < this.board.length; index++) {\r\n            const cell = this.board[index];\r\n            if (cell.SuCaiId == 0 && !cell.IsLiWu)\r\n            {\r\n                return true;\r\n            }\r\n        }\r\n        return false;\r\n    }\r\n\r\n    //是否有素材\r\n    public isHasSuCai() : boolean {\r\n        for (let index = 0; index < this.board.length; index++) {\r\n            const cell = this.board[index];\r\n            if (cell.SuCaiId > 0)\r\n            {\r\n                return true;\r\n            }\r\n        }\r\n        return false;\r\n    }\r\n\r\n    public GetUniqueSuCaiList() : BoardCell[] {\r\n        let uniqueIds = new Set<number>(); // 用于跟踪已经选过的 id\r\n        let SuCaiList: BoardCell[] = [];\r\n        for (let index = 0; index < this.board.length; index++) {\r\n            const cell = this.board[index];\r\n            // 如果该元素的 id 没有被选过，添加到结果中\r\n            if (cell.SuCaiId > 0 && !uniqueIds.has(cell.SuCaiId)) {\r\n                uniqueIds.add(cell.SuCaiId);\r\n                SuCaiList.push(cell);\r\n            }\r\n        }\r\n        return SuCaiList;\r\n    }\r\n\r\n    customSort = (a: BoardCell, b: BoardCell): number => {\r\n        if (a.SuCaiId > 0 && b.SuCaiId > 0)\r\n        {\r\n            this._tsIngredients.init(a.SuCaiId);\r\n            let aLevel = this._tsIngredients.level;\r\n            this._tsIngredients.init(b.SuCaiId);\r\n            let bLevel = this._tsIngredients.level;\r\n            if (aLevel !== bLevel) {\r\n              return bLevel - aLevel;\r\n            }\r\n            return a.SuCaiId - b.SuCaiId;\r\n        }\r\n        else\r\n        {\r\n            return b.SuCaiId - a.SuCaiId;\r\n        }\r\n    };\r\n\r\n    //排序\r\n    public sortGrid() {\r\n        this.board.sort(this.customSort);\r\n        let index = 0;\r\n        for (let row = 0; row < GAME_GRID_SIZE; row++) {\r\n            for (let col = 0; col < GAME_GRID_SIZE; col++) {\r\n                this.board[index].Position.row = row;\r\n                this.board[index].Position.col = col;\r\n                index++;\r\n            }\r\n        }\r\n    }\r\n\r\n    public getBoardListString() : string {\r\n        return JSON.stringify(this.board);\r\n    }\r\n\r\n    save() {\r\n        const boardJson = JSON.stringify(this.board);\r\n        oops.storage.set(GAME_Board_KEY, boardJson);\r\n    }\r\n\r\n    load(serverData) {\r\n        this.loadFromServer(serverData);\r\n        oops.message.on(GameEvent.OnGridContract, this.onUpdateData, this);\r\n    }\r\n\r\n    loadFromServer(serverData) {\r\n        this.setDataDefault();\r\n        if (serverData)\r\n        {\r\n            try {\r\n                this.save_data = JSON.parse(serverData.boardData)\r\n                this.setData();\r\n            } catch (e) {\r\n                this.setDataDefault();\r\n            }\r\n        }\r\n        else\r\n        {\r\n            this.setDataDefault();\r\n        }\r\n\r\n        if (this.board.length <= 0)\r\n        {\r\n            this.setDataDefault();\r\n        }\r\n    }\r\n\r\n    loadFromLocal() {\r\n        this.save_data = oops.storage.getJson(GAME_Board_KEY);\r\n        if (this.save_data) {\r\n            try {\r\n                this.setData();\r\n            } catch (e) {\r\n            } \r\n        }\r\n    }\r\n\r\n    private setData() {\r\n        console.log('setData 1\\n');\r\n        this.board = [];\r\n        this.board = this.save_data.map(\r\n            (cell: any) => new BoardCell(cell.Position.row, cell.Position.col, cell.SuCaiId, cell.IsLiWu)\r\n          );\r\n        console.log('setData 2\\n');\r\n        //每次登陆排序\r\n        this.sortGrid();\r\n        oops.message.dispatchEvent(GameEvent.UpdateBoardGrid);\r\n        console.log('setData 3\\n');\r\n    }\r\n    \r\n    //新号初始化\r\n    public setDataDefault() {\r\n        this.save_data = {};\r\n        this.board = [];\r\n        for (let row = 0; row < GAME_GRID_SIZE; row++) {\r\n            for (let col = 0; col < GAME_GRID_SIZE; col++) {\r\n                this.board.push(new BoardCell(row, col, 0, false));\r\n            }\r\n        }\r\n    }\r\n\r\n    private onUpdateData(event: string, args: any) {\r\n        switch (event) {\r\n            case GameEvent.OnGridContract:\r\n                this.OnGridContract(args);\r\n                break;\r\n        }\r\n    }\r\n\r\n    //格子碰撞\r\n    private OnGridContract(args: any)\r\n    {\r\n        let DestIndex = args.DestIndex;\r\n        let SrcIndex = args.SrcIndex;\r\n        if (this.board && this.board[DestIndex] && this.board[SrcIndex])\r\n        {\r\n            if (this.board[DestIndex].SuCaiId > 0 && this.board[SrcIndex].SuCaiId > 0)\r\n            {\r\n                if (this.board[DestIndex].SuCaiId == this.board[SrcIndex].SuCaiId)\r\n                {\r\n                    //相同素材进行合成操作\r\n                    HeChengMgr.HandleHecheng(SrcIndex, DestIndex);\r\n                }\r\n                else\r\n                {\r\n                    //不同素材进行交换操作\r\n                    this.SwapGrid(DestIndex, SrcIndex);\r\n                }\r\n            }\r\n            else\r\n            {\r\n                if (!this.board[DestIndex].IsLiWu && !this.board[SrcIndex].IsLiWu)\r\n                {//如果格子上有礼物不能交换\r\n                    //进行交换操作\r\n                    this.SwapGrid(DestIndex, SrcIndex);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    private SwapGrid(DestIndex:number, SrcIndex:number)\r\n    {\r\n        let TempASuCaiId = this.board[DestIndex].SuCaiId;\r\n        let TempBSuCaiId = this.board[SrcIndex].SuCaiId;\r\n        this.board[DestIndex].SuCaiId = TempBSuCaiId;\r\n        this.board[SrcIndex].SuCaiId = TempASuCaiId;\r\n\r\n\r\n        let TempAIsLiwu = this.board[DestIndex].IsLiWu;\r\n        let TempBIsLiwu = this.board[SrcIndex].IsLiWu;\r\n        this.board[DestIndex].IsLiWu = TempBIsLiwu;\r\n        this.board[SrcIndex].IsLiWu = TempAIsLiwu;\r\n\r\n        UtilMgr.PlaySoundEffect(15);\r\n        oops.message.dispatchEvent(GameEvent.UpdateBoardGrid);\r\n        oops.message.dispatchEvent(GameEvent.Save);\r\n    }\r\n}\r\n\r\nexport var BoardMgr = new BoardManager();"]}