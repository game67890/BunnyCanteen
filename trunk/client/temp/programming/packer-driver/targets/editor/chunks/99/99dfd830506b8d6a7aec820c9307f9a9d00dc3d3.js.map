{"version":3,"sources":["file:///F:/TON-Game/src/trunk/client/assets/scripts/framework/initialize/view/LoadingViewComp.ts"],"names":["_decorator","sys","ProgressBar","oops","JsonUtil","ecs","CCVMParentComp","GameEvent","UIID","TonMgr","TableRoleJob","TableRoleLevelUp","TablePictureSet","TablePay","TableGiftBox","TableRestaurantlevel","TableIngredients","TableAchievement","TableTask","TableRank","TableOtherParameter","TableRadishAwardWeight","TableRadishAwardRank","TableRadishAwardTime","TableShop","TableAccelerate","TableInvitedUserRank","TableSoundEffects","ccclass","property","LoadingViewComp","register","data","finished","total","progress","prompt","reset","setTimeout","gui","remove","Loading","start","isNative","enter","addEvent","loadRes","on","LoginSuccess","onHandler","event","args","ent","loadCustom","loadGameRes","language","getLangByID","Promise","resolve","reject","loadAsync","TableName","res","loadDir","onProgressCallback","bind","onCompleteCallback","item","progressBar","node","getComponentInChildren","Math","floor","init"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAMSA,MAAAA,U,OAAAA,U;AAAYC,MAAAA,G,OAAAA,G;AAAKC,MAAAA,W,OAAAA,W;;AACjBC,MAAAA,I,iBAAAA,I;;AACAC,MAAAA,Q,iBAAAA,Q;;AACAC,MAAAA,G,iBAAAA,G;;AACAC,MAAAA,c,iBAAAA,c;;AACAC,MAAAA,S,iBAAAA,S;;AACAC,MAAAA,I,iBAAAA,I;;AAEAC,MAAAA,M,iBAAAA,M;;AAGAC,MAAAA,Y,iBAAAA,Y;;AACAC,MAAAA,gB,kBAAAA,gB;;AACAC,MAAAA,e,kBAAAA,e;;AACAC,MAAAA,Q,kBAAAA,Q;;AACAC,MAAAA,Y,kBAAAA,Y;;AACAC,MAAAA,oB,kBAAAA,oB;;AACAC,MAAAA,gB,kBAAAA,gB;;AACAC,MAAAA,gB,kBAAAA,gB;;AACAC,MAAAA,S,kBAAAA,S;;AACAC,MAAAA,S,kBAAAA,S;;AACAC,MAAAA,mB,kBAAAA,mB;;AACAC,MAAAA,sB,kBAAAA,sB;;AACAC,MAAAA,oB,kBAAAA,oB;;AACAC,MAAAA,oB,kBAAAA,oB;;AACAC,MAAAA,S,kBAAAA,S;;AACAC,MAAAA,e,kBAAAA,e;;AACAC,MAAAA,oB,kBAAAA,oB;;AACAC,MAAAA,iB,kBAAAA,iB;;;;;;AAlCT;AACA;AACA;AACA;AACA;AACA;;;;;OAmCM;AAAEC,QAAAA,OAAF;AAAWC,QAAAA;AAAX,O,GAAwB7B,U;AAE9B;;iCAGa8B,e,WAFZF,OAAO,CAAC,iBAAD,C,UACP;AAAA;AAAA,sBAAIG,QAAJ,CAAa,aAAb,EAA4B,KAA5B,C,+BADD,MAEaD,eAFb;AAAA;AAAA,4CAEoD;AAAA;AAAA;;AAChD;AADgD,eAEhDE,IAFgD,GAEpC;AACR;AACAC,YAAAA,QAAQ,EAAE,CAFF;;AAGR;AACAC,YAAAA,KAAK,EAAE,CAJC;;AAKR;AACAC,YAAAA,QAAQ,EAAE,GANF;;AAOR;AACAC,YAAAA,MAAM,EAAE;AARA,WAFoC;AAAA,eAaxCD,QAbwC,GAarB,CAbqB;AAAA;;AAehDE,QAAAA,KAAK,GAAS;AACVC,UAAAA,UAAU,CAAC,MAAM;AACb;AACA;AAAA;AAAA,8BAAKC,GAAL,CAASC,MAAT,CAAgB;AAAA;AAAA,8BAAKC,OAArB;AAEH,WAJS,EAIP,GAJO,CAAV;AAKH;;AAEDC,QAAAA,KAAK,GAAG;AACJ,cAAI,CAACzC,GAAG,CAAC0C,QAAT,EAAmB;AACf,iBAAKC,KAAL;AACH;AACJ;;AAEDA,QAAAA,KAAK,GAAG;AACJ,eAAKC,QAAL;AACA,eAAKC,OAAL;AACH;;AAEOD,QAAAA,QAAQ,GAAG;AACf,eAAKE,EAAL,CAAQ;AAAA;AAAA,sCAAUC,YAAlB,EAAgC,KAAKC,SAArC,EAAgD,IAAhD;AACH;;AAEOA,QAAAA,SAAS,CAACC,KAAD,EAAgBC,IAAhB,EAA2B;AACxC,kBAAQD,KAAR;AACI,iBAAK;AAAA;AAAA,wCAAUF,YAAf;AACI;AACA,mBAAKI,GAAL,CAASZ,MAAT,CAAgBV,eAAhB;AACA;AAJR;AAMH;AAED;;;AACqB,cAAPgB,OAAO,GAAG;AACpB,eAAKd,IAAL,CAAUG,QAAV,GAAqB,CAArB;AACA,gBAAM,KAAKkB,UAAL,EAAN;AACA,eAAKC,WAAL;AACH;AAED;;;AACQD,QAAAA,UAAU,GAAG;AACjB;AACA,eAAKrB,IAAL,CAAUI,MAAV,GAAmB;AAAA;AAAA,4BAAKmB,QAAL,CAAcC,WAAd,CAA0B,mBAA1B,CAAnB;AAEA,iBAAO,IAAIC,OAAJ,CAAY,OAAOC,OAAP,EAAgBC,MAAhB,KAA2B;AAC1C,kBAAM;AAAA;AAAA,sCAASC,SAAT,CAAmB;AAAA;AAAA,8CAAaC,SAAhC,CAAN;AACA,kBAAM;AAAA;AAAA,sCAASD,SAAT,CAAmB;AAAA;AAAA,sDAAiBC,SAApC,CAAN;AACA,kBAAM;AAAA;AAAA,sCAASD,SAAT,CAAmB;AAAA;AAAA,oDAAgBC,SAAnC,CAAN;AACA,kBAAM;AAAA;AAAA,sCAASD,SAAT,CAAmB;AAAA;AAAA,sCAASC,SAA5B,CAAN;AACA,kBAAM;AAAA;AAAA,sCAASD,SAAT,CAAmB;AAAA;AAAA,8CAAaC,SAAhC,CAAN;AACA,kBAAM;AAAA;AAAA,sCAASD,SAAT,CAAmB;AAAA;AAAA,8DAAqBC,SAAxC,CAAN;AACA,kBAAM;AAAA;AAAA,sCAASD,SAAT,CAAmB;AAAA;AAAA,sDAAiBC,SAApC,CAAN;AACA,kBAAM;AAAA;AAAA,sCAASD,SAAT,CAAmB;AAAA;AAAA,sDAAiBC,SAApC,CAAN;AACA,kBAAM;AAAA;AAAA,sCAASD,SAAT,CAAmB;AAAA;AAAA,wCAAUC,SAA7B,CAAN;AACA,kBAAM;AAAA;AAAA,sCAASD,SAAT,CAAmB;AAAA;AAAA,wCAAUC,SAA7B,CAAN;AACA,kBAAM;AAAA;AAAA,sCAASD,SAAT,CAAmB;AAAA;AAAA,4DAAoBC,SAAvC,CAAN;AACA,kBAAM;AAAA;AAAA,sCAASD,SAAT,CAAmB;AAAA;AAAA,kEAAuBC,SAA1C,CAAN;AACA,kBAAM;AAAA;AAAA,sCAASD,SAAT,CAAmB;AAAA;AAAA,8DAAqBC,SAAxC,CAAN;AACA,kBAAM;AAAA;AAAA,sCAASD,SAAT,CAAmB;AAAA;AAAA,8DAAqBC,SAAxC,CAAN;AACA,kBAAM;AAAA;AAAA,sCAASD,SAAT,CAAmB;AAAA;AAAA,wCAAUC,SAA7B,CAAN;AACA,kBAAM;AAAA;AAAA,sCAASD,SAAT,CAAmB;AAAA;AAAA,oDAAgBC,SAAnC,CAAN;AACA,kBAAM;AAAA;AAAA,sCAASD,SAAT,CAAmB;AAAA;AAAA,8DAAqBC,SAAxC,CAAN;AACA,kBAAM;AAAA;AAAA,sCAASD,SAAT,CAAmB;AAAA;AAAA,wDAAkBC,SAArC,CAAN;AACAH,YAAAA,OAAO,CAAC,IAAD,CAAP;AACH,WApBM,CAAP;AAqBH;AAED;;;AACQJ,QAAAA,WAAW,GAAG;AAClB;AACA;AACA;AACA;AACA;AAAA;AAAA,4BAAKQ,GAAL,CAASC,OAAT,CAAiB,kBAAjB;AACA;AAAA;AAAA,4BAAKD,GAAL,CAASC,OAAT,CAAiB,mBAAjB,EAAsC,KAAKC,kBAAL,CAAwBC,IAAxB,CAA6B,IAA7B,CAAtC,EAA0E,KAAKC,kBAAL,CAAwBD,IAAxB,CAA6B,IAA7B,CAA1E;AAEH;AAED;;;AACQD,QAAAA,kBAAkB,CAAC/B,QAAD,EAAmBC,KAAnB,EAAkCiC,IAAlC,EAA6C;AACnE,eAAKnC,IAAL,CAAUC,QAAV,GAAqBA,QAArB;AACA,eAAKD,IAAL,CAAUE,KAAV,GAAkBA,KAAlB;AAEA,cAAIC,QAAQ,GAAGF,QAAQ,GAAGC,KAA1B;;AACA,cAAIC,QAAQ,GAAG,KAAKA,QAApB,EAA8B;AAC1B,iBAAKA,QAAL,GAAgBA,QAAhB;AACA,kBAAMiC,WAAW,GAAG,KAAKC,IAAL,CAAUC,sBAAV,CAAiCpE,WAAjC,CAApB;;AACA,gBAAIkE,WAAJ,EAAiB;AACb;AACAA,cAAAA,WAAW,CAACjC,QAAZ,GAAuB,KAAKA,QAA5B;AACH;;AACD,iBAAKH,IAAL,CAAUG,QAAV,GAAqBoC,IAAI,CAACC,KAAL,CAAYrC,QAAQ,GAAG,GAAvB,IAA6B,GAAlD;AACH;AACJ;AAED;;;AACQ+B,QAAAA,kBAAkB,GAAG;AACzB;AACA;AACA;AAAA;AAAA,gCAAOO,IAAP;AACH;;AAnH+C,O","sourcesContent":["/*\r\n * @Author: dgflash\r\n * @Date: 2021-07-03 16:13:17\r\n * @LastEditors: dgflash\r\n * @LastEditTime: 2022-08-29 13:37:08\r\n */\r\nimport { _decorator, sys, ProgressBar, Label } from \"cc\";\r\nimport { oops } from \"../../../../../extensions/oops-plugin-framework/assets/core/Oops\";\r\nimport { JsonUtil } from \"../../../../../extensions/oops-plugin-framework/assets/core/utils/JsonUtil\";\r\nimport { ecs } from \"../../../../../extensions/oops-plugin-framework/assets/libs/ecs/ECS\";\r\nimport { CCVMParentComp } from \"../../../../../extensions/oops-plugin-framework/assets/module/common/CCVMParentComp\";\r\nimport { GameEvent } from \"../../common/config/GameEvent\";\r\nimport { UIID } from \"../../common/config/GameUIConfig\";\r\nimport { smc } from \"../../common/ecs/SingletonModuleComp\";\r\nimport { TonMgr } from \"../../../tongame/ton/TonManager\";\r\nimport { TonGameMgr } from \"../../../tongame/manager/TonGameManager\";\r\n\r\nimport { TableRoleJob } from \"../../common/table/TableRoleJob\";\r\nimport { TableRoleLevelUp } from \"../../common/table/TableRoleLevelUp\";\r\nimport { TablePictureSet } from \"../../common/table/TablePictureSet\";\r\nimport { TablePay } from \"../../common/table/TablePay\";\r\nimport { TableGiftBox } from \"../../common/table/TableGiftBox\";\r\nimport { TableRestaurantlevel } from \"../../common/table/TableRestaurantlevel\";\r\nimport { TableIngredients } from \"../../common/table/TableIngredients\";\r\nimport { TableAchievement } from \"../../common/table/TableAchievement\";\r\nimport { TableTask } from \"../../common/table/TableTask\";\r\nimport { TableRank } from \"../../common/table/TableRank\";\r\nimport { TableOtherParameter } from \"../../common/table/TableOtherParameter\";\r\nimport { TableRadishAwardWeight } from \"../../common/table/TableRadishAwardWeight\";\r\nimport { TableRadishAwardRank } from \"../../common/table/TableRadishAwardRank\";\r\nimport { TableRadishAwardTime } from \"../../common/table/TableRadishAwardTime\";\r\nimport { TableShop } from \"../../common/table/TableShop\";\r\nimport { TableAccelerate } from \"../../common/table/TableAccelerate\";\r\nimport { TableInvitedUserRank } from \"../../common/table/TableInvitedUserRank\";\r\nimport { TableSoundEffects } from \"../../common/table/TableSoundEffects\";\r\nimport { AcceleratedBuffMgr } from \"../../../tongame/acceleratedbuff/AcceleratedBuffManager\";\r\nimport { UtilMgr } from \"../../../tongame/manager/UtilManager\";\r\n\r\n\r\n\r\nconst { ccclass, property } = _decorator;\r\n\r\n/** 游戏资源加载 */\r\n@ccclass('LoadingViewComp')\r\n@ecs.register('LoadingView', false)\r\nexport class LoadingViewComp extends CCVMParentComp {\r\n    /** VM 组件绑定数据 */\r\n    data: any = {\r\n        /** 加载资源当前进度 */\r\n        finished: 0,\r\n        /** 加载资源最大进度 */\r\n        total: 0,\r\n        /** 加载资源进度比例值 */\r\n        progress: \"0\",\r\n        /** 加载流程中提示文本 */\r\n        prompt: \"\"\r\n    };\r\n\r\n    private progress: number = 0;\r\n\r\n    reset(): void {\r\n        setTimeout(() => {\r\n            // 关闭加载界面\r\n            oops.gui.remove(UIID.Loading);\r\n\r\n        }, 500);\r\n    }\r\n\r\n    start() {\r\n        if (!sys.isNative) {\r\n            this.enter();\r\n        }\r\n    }\r\n\r\n    enter() {\r\n        this.addEvent();\r\n        this.loadRes();\r\n    }\r\n\r\n    private addEvent() {\r\n        this.on(GameEvent.LoginSuccess, this.onHandler, this);\r\n    }\r\n\r\n    private onHandler(event: string, args: any) {\r\n        switch (event) {\r\n            case GameEvent.LoginSuccess:\r\n                // 加载流程结束，移除加载提示界面\r\n                this.ent.remove(LoadingViewComp);\r\n                break;\r\n        }\r\n    }\r\n\r\n    /** 加载资源 */\r\n    private async loadRes() {\r\n        this.data.progress = 0;\r\n        await this.loadCustom();\r\n        this.loadGameRes();\r\n    }\r\n\r\n    /** 加载游戏本地JSON数据（自定义内容） */\r\n    private loadCustom() {\r\n        // 加载游戏本地JSON数据的多语言提示文本\r\n        this.data.prompt = oops.language.getLangByID(\"loading_load_json\");\r\n\r\n        return new Promise(async (resolve, reject) => {\r\n            await JsonUtil.loadAsync(TableRoleJob.TableName);\r\n            await JsonUtil.loadAsync(TableRoleLevelUp.TableName);\r\n            await JsonUtil.loadAsync(TablePictureSet.TableName);\r\n            await JsonUtil.loadAsync(TablePay.TableName);\r\n            await JsonUtil.loadAsync(TableGiftBox.TableName);\r\n            await JsonUtil.loadAsync(TableRestaurantlevel.TableName);\r\n            await JsonUtil.loadAsync(TableIngredients.TableName);\r\n            await JsonUtil.loadAsync(TableAchievement.TableName);\r\n            await JsonUtil.loadAsync(TableTask.TableName);\r\n            await JsonUtil.loadAsync(TableRank.TableName);\r\n            await JsonUtil.loadAsync(TableOtherParameter.TableName);\r\n            await JsonUtil.loadAsync(TableRadishAwardWeight.TableName);\r\n            await JsonUtil.loadAsync(TableRadishAwardRank.TableName);\r\n            await JsonUtil.loadAsync(TableRadishAwardTime.TableName);\r\n            await JsonUtil.loadAsync(TableShop.TableName);\r\n            await JsonUtil.loadAsync(TableAccelerate.TableName);\r\n            await JsonUtil.loadAsync(TableInvitedUserRank.TableName);\r\n            await JsonUtil.loadAsync(TableSoundEffects.TableName);\r\n            resolve(null);\r\n        });\r\n    }\r\n\r\n    /** 加载初始游戏内容资源 */\r\n    private loadGameRes() {\r\n        // 加载初始游戏内容资源的多语言提示文本\r\n        //this.data.prompt = oops.language.getLangByID(\"loading_load_game\");\r\n        //oops.res.loadDir(\"audios\", null, UtilMgr.onAudioCompleteCallback);\r\n        //oops.res.loadDir(\"audios\");\r\n        oops.res.loadDir(\"prefab/ui/shouyi\");\r\n        oops.res.loadDir(\"prefab/ui/hecheng\", this.onProgressCallback.bind(this), this.onCompleteCallback.bind(this));\r\n\r\n    }\r\n\r\n    /** 加载进度事件 */\r\n    private onProgressCallback(finished: number, total: number, item: any) {\r\n        this.data.finished = finished;\r\n        this.data.total = total;\r\n\r\n        var progress = finished / total;\r\n        if (progress > this.progress) {\r\n            this.progress = progress;\r\n            const progressBar = this.node.getComponentInChildren(ProgressBar);\r\n            if (progressBar) {\r\n                // 设置进度条的进度（范围从 0 到 1）\r\n                progressBar.progress = this.progress;\r\n            }\r\n            this.data.progress = Math.floor((progress * 100))+\"%\";\r\n        }\r\n    }\r\n\r\n    /** 加载完成事件 */\r\n    private onCompleteCallback() {\r\n        // 获取用户信息的多语言提示文本\r\n        //this.data.prompt = oops.language.getLangByID(\"loading_load_player\");\r\n        TonMgr.init();\r\n    }\r\n}"]}