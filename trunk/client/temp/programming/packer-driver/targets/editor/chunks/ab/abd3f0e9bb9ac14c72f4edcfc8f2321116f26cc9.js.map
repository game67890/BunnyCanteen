{"version":3,"sources":["file:///F:/TON-Game/src/trunk/client/assets/scripts/framework/initialize/view/HotUpdate.ts"],"names":["Component","game","sys","_decorator","oops","UIID","tips","Hot","HotOptions","LoadingViewComp","ccclass","property","HotUpdate","hot","lv","onLoad","isNative","getComponent","data","prompt","language","getLangByID","startHotUpdate","options","onVersionInfo","onUpdateProgress","event","pc","getPercent","_total","getTotalBytes","_have","getDownloadedBytes","total","have","Math","ceil","toFixed","parseInt","isNaN","finished","getDownloadedFiles","getTotalFiles","progress","onNeedToUpdate","totalBytes","checkForceUpdate","showUpdateDialog","hotUpdate","onNoNeedToUpdate","enter","onUpdateFailed","checkUpdate","onUpdateSucceed","setTimeout","restart","init","callback","operate","title","content","okWord","cancelWord","okFunc","clearHotUpdateStorage","cancelFunc","end","needCancel","gui","open","Window","size","getNetworkType","NetworkType","LAN","alert"],"mappings":"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","sourcesContent":["/*\r\n * @Author: dgflash\r\n * @Date: 2022-04-15 14:44:04\r\n * @LastEditors: dgflash\r\n * @LastEditTime: 2022-08-29 14:13:42\r\n */\r\nimport { Component, game, sys, _decorator } from \"cc\";\r\nimport { oops } from \"../../../../../extensions/oops-plugin-framework/assets/core/Oops\";\r\nimport { UIID } from \"../../common/config/GameUIConfig\";\r\nimport { tips } from \"../../common/prompt/TipsManager\";\r\nimport { Hot, HotOptions } from \"./Hot\";\r\nimport { LoadingViewComp } from \"./LoadingViewComp\";\r\n\r\nconst { ccclass, property } = _decorator;\r\n\r\n/** 热更新界面控制脚本 */\r\n@ccclass('HotUpdate')\r\nexport class HotUpdate extends Component {\r\n    /** 热更新业务管理对象 */\r\n    private hot = new Hot();\r\n    /** 公用加载界面UI做更新提示 */\r\n    private lv: LoadingViewComp = null!;\r\n\r\n    onLoad() {\r\n        if (sys.isNative) {\r\n            this.lv = this.getComponent(LoadingViewComp)!;\r\n            this.lv.data.prompt = oops.language.getLangByID(\"update_tips_check_update\");\r\n            this.startHotUpdate();\r\n        }\r\n    }\r\n\r\n    /** 开始热更新 */\r\n    private startHotUpdate() {\r\n        let options = new HotOptions();\r\n        options.onVersionInfo = (data: any) => {\r\n            // console.log(`【热更新界面】本地版本:${data.local},远程版本:${data.server}`);\r\n        };\r\n        options.onUpdateProgress = (event: jsb.EventAssetsManager) => {\r\n            // 进度提示字\r\n            let pc = event.getPercent();\r\n            let _total = event.getTotalBytes();\r\n            let _have = event.getDownloadedBytes();\r\n\r\n            let total: string, have: string;\r\n            if (_total < 1048576) {                              // 小于1m，就显示kb\r\n                _total = Math.ceil(_total / 1024)\r\n                total = _total + 'K'\r\n            }\r\n            else {                                               // 显示m\r\n                total = (_total / (1024 * 1024)).toFixed(1);\r\n                total = total + 'M'\r\n            }\r\n\r\n            if (_have < 1048576) {                               // 小于1m，就显示kb\r\n                _have = Math.ceil(_have / 1024)\r\n                have = _have + 'K'\r\n            }\r\n            else {                                               // 显示m\r\n                have = (_have / (1024 * 1024)).toFixed(1);\r\n                have = have + 'M'\r\n            }\r\n\r\n            if (total == '0K') {\r\n                this.lv.data.prompt = oops.language.getLangByID(\"update_tips_check_update\");\r\n            }\r\n            else {\r\n                this.lv.data.prompt = oops.language.getLangByID(\"update_tips_update\") + have + '/' + total + ' (' + parseInt(pc * 100 + \"\") + '%)';\r\n            }\r\n\r\n            // 进度条\r\n            if (!isNaN(event.getPercent())) {\r\n                this.lv.data.finished = event.getDownloadedFiles();\r\n                this.lv.data.total = event.getTotalFiles();\r\n                this.lv.data.progress = (event.getPercent() * 100).toFixed(2);\r\n            }\r\n        };\r\n        options.onNeedToUpdate = (data: any, totalBytes: number) => {\r\n            this.lv.data.prompt = oops.language.getLangByID(\"update_tips_new_version\");\r\n            let total: string = \"\";\r\n            if (totalBytes < 1048576) {                                 // 小于1m，就显示kb\r\n                // totalBytes = Math.ceil(totalBytes / 1024);\r\n                // total = total + 'KB';\r\n                total = Math.ceil(totalBytes / 1024) + 'KB';\r\n            }\r\n            else {\r\n                total = (totalBytes / (1024 * 1024)).toFixed(1);\r\n                total = total + 'MB';\r\n            }\r\n\r\n            // 提示更新\r\n            this.checkForceUpdate(() => {\r\n                // 非 WIFI 环境提示玩家\r\n                this.showUpdateDialog(total, () => {\r\n                    this.hot.hotUpdate();\r\n                })\r\n            });\r\n        };\r\n        options.onNoNeedToUpdate = () => {\r\n            this.lv.enter();\r\n        };\r\n        options.onUpdateFailed = () => {\r\n            this.lv.data.prompt = oops.language.getLangByID(\"update_tips_update_fail\");\r\n            this.hot.checkUpdate();\r\n        };\r\n        options.onUpdateSucceed = () => {\r\n            this.lv.data.progress = 100;\r\n            this.lv.data.prompt = oops.language.getLangByID(\"update_tips_update_success\");\r\n\r\n            setTimeout(() => {\r\n                game.restart();\r\n            }, 1000);\r\n        };\r\n\r\n        this.hot.init(options);\r\n    }\r\n\r\n    /** 检查是否强制更新信息 */\r\n    private checkForceUpdate(callback: Function) {\r\n        let operate: any = {\r\n            title: 'common_prompt_title_sys',\r\n            content: \"update_tips_force\",\r\n            okWord: 'common_prompt_ok',\r\n            cancelWord: 'common_prompt_cancal',\r\n            okFunc: () => {\r\n                this.hot.clearHotUpdateStorage();\r\n                callback();\r\n            },\r\n            cancelFunc: () => {\r\n                game.end();\r\n            },\r\n            needCancel: true\r\n        };\r\n        oops.gui.open(UIID.Window, operate);\r\n    }\r\n\r\n    /** 非 WIFI 环境提示玩家 */\r\n    private showUpdateDialog(size: string, callback: Function) {\r\n        if (sys.getNetworkType() == sys.NetworkType.LAN) {\r\n            callback();\r\n            return;\r\n        }\r\n        tips.alert(oops.language.getLangByID(\"update_nowifi_tip\") + size, callback);\r\n    }\r\n}"]}