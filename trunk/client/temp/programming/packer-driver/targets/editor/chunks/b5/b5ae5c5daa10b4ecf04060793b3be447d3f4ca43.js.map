{"version":3,"sources":["file:///F:/TON-Game/src/trunk/client/assets/scripts/framework/initialize/view/Hot.ts"],"names":["HotOptions","Hot","error","log","native","sys","oops","onVersionInfo","onNeedToUpdate","onNoNeedToUpdate","onUpdateFailed","onUpdateSucceed","onUpdateProgress","check","key","assetsMgr","options","state","State","None","storagePath","manifest","init","opt","isNative","res","load","err","showSearchPath","nativeUrl","fileUtils","getWritablePath","AssetsManager","versionA","versionB","console","local","server","vA","split","vB","i","length","a","parseInt","b","setVerifyCallback","path","asset","compressed","expectedMD5","md5","relativePath","size","localManifest","getLocalManifest","getPackageUrl","getManifestFileUrl","getVersionFileUrl","checkUpdate","clearHotUpdateStorage","removeDirectory","getState","jsb","UNINITED","isLoaded","setEventCallback","onHotUpdateCallBack","bind","Check","hotUpdate","Update","update","event","code","getEventCode","EventAssetsManager","ALREADY_UP_TO_DATE","NEW_VERSION_FOUND","getTotalBytes","ASSET_UPDATED","UPDATE_PROGRESSION","getDownloadedFiles","getTotalFiles","getPercent","UPDATE_FINISHED","onUpdateFinished","searchPaths","getSearchPaths","newPaths","Array","prototype","unshift","apply","localStorage","setItem","JSON","stringify","setSearchPaths"],"mappings":"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","sourcesContent":["import { error, log, native, sys } from \"cc\";\r\nimport { oops } from \"../../../../../extensions/oops-plugin-framework/assets/core/Oops\";\r\n\r\n/** 热更参数 */\r\nexport class HotOptions {\r\n    /** 获取到版本号信息 */\r\n    onVersionInfo: Function | null = null;\r\n    /** 发现新版本，请更新 */\r\n    onNeedToUpdate: Function | null = null;\r\n    /** 和远程版本一致，无须更新 */\r\n    onNoNeedToUpdate: Function | null = null;\r\n    /** 更新失败 */\r\n    onUpdateFailed: Function | null = null;\r\n    /** 更新完成 */\r\n    onUpdateSucceed: Function | null = null;\r\n    /** 更新进度 */\r\n    onUpdateProgress: Function | null = null;\r\n\r\n    check() {\r\n        for (let key in this) {\r\n            if (key !== 'check') {\r\n                if (!this[key]) {\r\n                    log(`参数HotOptions.${key}未设置！`);\r\n                    return false;\r\n                }\r\n            }\r\n        }\r\n        return true\r\n    }\r\n}\r\n\r\n/** 热更管理 */\r\nexport class Hot {\r\n    private assetsMgr: native.AssetsManager = null!;\r\n    private options: HotOptions | null = null;\r\n    private state = Hot.State.None;\r\n    private storagePath: string = \"\";\r\n    private manifest: string = \"\";\r\n\r\n    static State = {\r\n        None: 0,\r\n        Check: 1,\r\n        Update: 2,\r\n    }\r\n\r\n    /** 热更初始化 */\r\n    init(opt: HotOptions) {\r\n        if (!sys.isNative) {\r\n            return;\r\n        }\r\n        if (!opt.check()) {\r\n            return;\r\n        }\r\n        this.options = opt;\r\n\r\n        if (this.assetsMgr) {\r\n            return;\r\n        }\r\n\r\n        oops.res.load('project', (err: Error | null, res: any) => {\r\n            if (err) {\r\n                error(\"【热更新界面】缺少热更新配置文件\");\r\n                return;\r\n            }\r\n\r\n            this.showSearchPath();\r\n\r\n            this.manifest = res.nativeUrl;\r\n            this.storagePath = `${native.fileUtils.getWritablePath()}oops_framework_remote`;\r\n            this.assetsMgr = new native.AssetsManager(this.manifest, this.storagePath, (versionA, versionB) => {\r\n                console.log(\"【热更新】客户端版本: \" + versionA + ', 当前最新版本: ' + versionB);\r\n                this.options?.onVersionInfo && this.options.onVersionInfo({ local: versionA, server: versionB });\r\n\r\n                let vA = versionA.split('.');\r\n                let vB = versionB.split('.');\r\n                for (let i = 0; i < vA.length; ++i) {\r\n                    let a = parseInt(vA[i]);\r\n                    let b = parseInt(vB[i] || '0');\r\n                    if (a !== b) {\r\n                        return a - b;\r\n                    }\r\n                }\r\n\r\n                if (vB.length > vA.length) {\r\n                    return -1;\r\n                }\r\n                else {\r\n                    return 0;\r\n                }\r\n            });\r\n\r\n            // 设置验证回调，如果验证通过，则返回true，否则返回false\r\n            this.assetsMgr.setVerifyCallback((path: string, asset: jsb.ManifestAsset) => {\r\n                // 压缩资源时，我们不需要检查其md5，因为zip文件已被删除\r\n                var compressed = asset.compressed;\r\n                // 检索正确的md5值\r\n                var expectedMD5 = asset.md5;\r\n                // 资源路径是相对路径，路径是绝对路径\r\n                var relativePath = asset.path;\r\n                // 资源文件的大小，但此值可能不存在\r\n                var size = asset.size;\r\n\r\n                return true;\r\n            });\r\n\r\n            var localManifest = this.assetsMgr.getLocalManifest();\r\n            console.log('【热更新】热更资源存放路径: ' + this.storagePath);\r\n            console.log('【热更新】本地资源配置路径: ' + this.manifest);\r\n            console.log('【热更新】本地包地址: ' + localManifest.getPackageUrl());\r\n            console.log('【热更新】远程 project.manifest 地址: ' + localManifest.getManifestFileUrl());\r\n            console.log('【热更新】远程 version.manifest 地址: ' + localManifest.getVersionFileUrl());\r\n\r\n            this.checkUpdate();\r\n        });\r\n    }\r\n\r\n    /** 删除热更所有存储文件 */\r\n    clearHotUpdateStorage() {\r\n        native.fileUtils.removeDirectory(this.storagePath);\r\n    }\r\n\r\n    // 检查更新\r\n    checkUpdate() {\r\n        if (!this.assetsMgr) {\r\n            console.log('【热更新】请先初始化')\r\n            return;\r\n        }\r\n\r\n        if (this.assetsMgr.getState() === jsb.AssetsManager.State.UNINITED) {\r\n            error('【热更新】未初始化')\r\n            return;\r\n        }\r\n        if (!this.assetsMgr.getLocalManifest().isLoaded()) {\r\n            console.log('【热更新】加载本地 manifest 失败 ...');\r\n            return;\r\n        }\r\n        this.assetsMgr.setEventCallback(this.onHotUpdateCallBack.bind(this));\r\n        this.state = Hot.State.Check;\r\n        // 下载version.manifest，进行版本比对\r\n        this.assetsMgr.checkUpdate();\r\n    }\r\n\r\n    /** 开始更热 */\r\n    hotUpdate() {\r\n        if (!this.assetsMgr) {\r\n            console.log('【热更新】请先初始化')\r\n            return\r\n        }\r\n        this.assetsMgr.setEventCallback(this.onHotUpdateCallBack.bind(this));\r\n        this.state = Hot.State.Update;\r\n        this.assetsMgr.update();\r\n    }\r\n\r\n    private onHotUpdateCallBack(event: native.EventAssetsManager) {\r\n        let code = event.getEventCode();\r\n        switch (code) {\r\n            case native.EventAssetsManager.ALREADY_UP_TO_DATE:\r\n                console.log(\"【热更新】当前版本与远程版本一致且无须更新\");\r\n                this.options?.onNoNeedToUpdate && this.options.onNoNeedToUpdate(code)\r\n                break;\r\n            case native.EventAssetsManager.NEW_VERSION_FOUND:\r\n                console.log('【热更新】发现新版本,请更新');\r\n                this.options?.onNeedToUpdate && this.options.onNeedToUpdate(code, this.assetsMgr!.getTotalBytes());\r\n                break;\r\n            case native.EventAssetsManager.ASSET_UPDATED:\r\n                console.log('【热更新】资产更新');\r\n                break;\r\n            case native.EventAssetsManager.UPDATE_PROGRESSION:\r\n                if (this.state === Hot.State.Update) {\r\n                    // event.getPercent();\r\n                    // event.getPercentByFile();\r\n                    // event.getDownloadedFiles() + ' / ' + event.getTotalFiles();\r\n                    // event.getDownloadedBytes() + ' / ' + event.getTotalBytes();\r\n                    console.log('【热更新】更新中...', event.getDownloadedFiles(), event.getTotalFiles(), event.getPercent());\r\n                    this.options?.onUpdateProgress && this.options.onUpdateProgress(event);\r\n                }\r\n                break;\r\n            case native.EventAssetsManager.UPDATE_FINISHED:\r\n                this.onUpdateFinished();\r\n                break;\r\n            default:\r\n                this.onUpdateFailed(code);\r\n                break;\r\n        }\r\n    }\r\n\r\n    private onUpdateFailed(code: any) {\r\n        this.assetsMgr.setEventCallback(null!)\r\n        this.options?.onUpdateFailed && this.options.onUpdateFailed(code);\r\n    }\r\n\r\n    private onUpdateFinished() {\r\n        this.assetsMgr.setEventCallback(null!);\r\n        let searchPaths = native.fileUtils.getSearchPaths();\r\n        let newPaths = this.assetsMgr.getLocalManifest().getSearchPaths();\r\n        Array.prototype.unshift.apply(searchPaths, newPaths);\r\n        localStorage.setItem('HotUpdateSearchPaths', JSON.stringify(searchPaths));\r\n        native.fileUtils.setSearchPaths(searchPaths);\r\n\r\n        console.log('【热更新】更新成功');\r\n        this.options?.onUpdateSucceed && this.options.onUpdateSucceed();\r\n    }\r\n\r\n    private showSearchPath() {\r\n        console.log(\"========================搜索路径========================\");\r\n        let searchPaths = native.fileUtils.getSearchPaths();\r\n        for (let i = 0; i < searchPaths.length; i++) {\r\n            console.log(\"[\" + i + \"]: \" + searchPaths[i]);\r\n        }\r\n        console.log(\"======================================================\");\r\n    }\r\n}"]}