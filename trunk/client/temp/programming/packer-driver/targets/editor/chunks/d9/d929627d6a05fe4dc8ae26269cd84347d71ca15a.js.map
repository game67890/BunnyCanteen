{"version":3,"sources":["file:///F:/TON-Game/src/trunk/client/extensions/oops-plugin-framework/assets/libs/extension/NodeDragExt.ts"],"names":["Node","Vec2","js","v3","prototype","_DragEvent","DRAG_START","DRAG_MOVE","DRAG_END","mixin","DragEvent","_draggable","_dragging","_dragTesting","_dragStartPoint","initDrag","on","EventType","TOUCH_START","onTouchBegin_0","TOUCH_MOVE","onTouchMove_0","TOUCH_END","onTouchEnd_0","TOUCH_CANCEL","onTouchCancel_0","off","event","pos","getUILocation","set","sensitivity","Math","abs","x","y","emit","delta","getUIDelta","position","add","startDrag","activeInHierarchy","dragBegin","dragEnd","stopDrag","removeDragEvent","Object","defineProperty","get","value","enumerable","configurable"],"mappings":"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","sourcesContent":["\r\nimport { EventTouch, Node, Vec2, js, v3 } from \"cc\";\r\n\r\n/** 节点拖拽功能 */\r\n//@ts-ignore\r\nif (!Node.prototype[\"__$NodeDragExt$__\"]) {\r\n    //@ts-ignore\r\n    Node.prototype[\"__$NodeDragExt$__\"] = true;\r\n\r\n    let _DragEvent = {\r\n        DRAG_START: \"drag_start\",\r\n        DRAG_MOVE: \"drag_move\",\r\n        DRAG_END: \"drag_end\"\r\n    }\r\n\r\n    js.mixin(Node, {\r\n        DragEvent: _DragEvent\r\n    });\r\n\r\n    //----------------   Node 添加 拖拽属性 ----------------\r\n\r\n    js.mixin(Node.prototype, {\r\n        _draggable: false,\r\n        _dragging: false,\r\n        _dragTesting: false,\r\n        _dragStartPoint: null,\r\n        initDrag: function () {\r\n            if (this._draggable) {\r\n                this.on(Node.EventType.TOUCH_START, this.onTouchBegin_0, this);\r\n                this.on(Node.EventType.TOUCH_MOVE, this.onTouchMove_0, this);\r\n                this.on(Node.EventType.TOUCH_END, this.onTouchEnd_0, this);\r\n                this.on(Node.EventType.TOUCH_CANCEL, this.onTouchCancel_0, this);\r\n            }\r\n            else {\r\n                this.off(Node.EventType.TOUCH_START, this.onTouchBegin_0, this);\r\n                this.off(Node.EventType.TOUCH_MOVE, this.onTouchMove_0, this);\r\n                this.off(Node.EventType.TOUCH_END, this.onTouchEnd_0, this);\r\n                this.off(Node.EventType.TOUCH_CANCEL, this.onTouchCancel_0, this);\r\n            }\r\n        },\r\n        onTouchBegin_0: function (event: EventTouch) {\r\n            if (this._dragStartPoint == null) {\r\n                this._dragStartPoint = new Vec2();\r\n            }\r\n            // DEV && console.log(`NodeDragExt -> onTouchBegin_0  ${this.name}`);\r\n\r\n            // event.preventSwallow = true;\r\n            let pos = event.getUILocation();\r\n            this._dragStartPoint.set(pos);\r\n            this._dragTesting = true;\r\n        },\r\n        onTouchMove_0: function (event: EventTouch) {\r\n            if (!this._dragging && this._draggable && this._dragTesting) {\r\n                let sensitivity = 10;\r\n                let pos = event.getUILocation();\r\n                if (Math.abs(this._dragStartPoint.x - pos.x) < sensitivity\r\n                    && Math.abs(this._dragStartPoint.y - pos.y) < sensitivity) {\r\n                    return;\r\n                }\r\n\r\n                // event.preventSwallow = true;\r\n                this._dragging = true;\r\n                this._dragTesting = false;\r\n                this.emit(Node.DragEvent.DRAG_START, event);\r\n            }\r\n\r\n            if (this._dragging) {\r\n                let delta = event.getUIDelta();\r\n                // /** 这里除以 世界缩放，在有缩放的时候拖拽不至于很怪 */\r\n                // this.position = this.position.add(v3(delta.x / this.worldScale.x, delta.y / this.worldScale.y, 0));\r\n                this.position = this.position.add(v3(delta.x, delta.y, 0));\r\n                this.emit(Node.DragEvent.DRAG_MOVE, event);\r\n            }\r\n        },\r\n\r\n        onTouchEnd_0: function (event: EventTouch) {\r\n            if (this._dragging) {\r\n                this._dragging = false;\r\n                this.emit(Node.DragEvent.DRAG_END, event);\r\n            }\r\n            // DEV && console.log(`NodeDragExt -> onTouchEnd_0  ${this.name}, _dragging: ${this._dragging}`);\r\n        },\r\n\r\n        onTouchCancel_0: function (event: EventTouch) {\r\n            if (this._dragging) {\r\n                this._dragging = false;\r\n                this.emit(Node.DragEvent.DRAG_END, event);\r\n            }\r\n            // DEV && console.log(`NodeDragExt -> onTouchCancel_0  ${this.name}, _dragging: ${this._dragging}`);\r\n        },\r\n\r\n        startDrag: function () {\r\n            // 此节点是否在场景中激活\r\n            if (!this.activeInHierarchy) {\r\n                return;\r\n            }\r\n            this.dragBegin();\r\n        },\r\n\r\n        dragBegin: function () {\r\n            this._dragging = true;\r\n            this._dragTesting = true;\r\n            this.on(Node.EventType.TOUCH_MOVE, this.onTouchMove_0, this);\r\n            this.on(Node.EventType.TOUCH_END, this.onTouchEnd_0, this);\r\n            this.on(Node.EventType.TOUCH_CANCEL, this.onTouchCancel_0, this);\r\n        },\r\n        dragEnd: function () {\r\n            if (this._dragging) {\r\n                this._dragTesting = false;\r\n                this._dragging = false;\r\n            }\r\n        },\r\n\r\n        // 停止拖拽\r\n        stopDrag: function () {\r\n            this.dragEnd();\r\n        },\r\n\r\n        // 移除 touch 事件\r\n        removeDragEvent: function () {\r\n            this.off(Node.EventType.TOUCH_START, this.onTouchBegin_0, this);\r\n            this.off(Node.EventType.TOUCH_MOVE, this.onTouchMove_0, this);\r\n            this.off(Node.EventType.TOUCH_END, this.onTouchEnd_0, this);\r\n            this.off(Node.EventType.TOUCH_CANCEL, this.onTouchCancel_0, this);\r\n        }\r\n    });\r\n\r\n    // 如果 node 设置 node.draggable = true, 则启用 拖拽\r\n    Object.defineProperty(Node.prototype, \"draggable\", {\r\n        get: function () {\r\n            return this._draggable;\r\n        },\r\n        set: function (value) {\r\n            if (this._draggable != value) {\r\n                this._draggable = value;\r\n                this.initDrag();\r\n            }\r\n        },\r\n        enumerable: true,\r\n        configurable: true\r\n    });\r\n\r\n    Object.defineProperty(Node.prototype, \"dragTesting\", {\r\n        get: function () {\r\n            return this._dragTesting;\r\n        },\r\n        set: function (value) {\r\n            if (this._dragTesting != value) {\r\n                this._dragTesting = value;\r\n            }\r\n        },\r\n        enumerable: true,\r\n        configurable: true\r\n    });\r\n    //----------------   Node 添加 拖拽属性 ----------------\r\n}\r\n\r\ndeclare module \"cc\" {\r\n    // 这里使用 interface 进行扩展，如果使用 class 则会与现有的 d.ts 有冲突\r\n    export interface Node {\r\n        /** 是否启动拖拽 - true为启动 */\r\n        draggable: boolean;\r\n        /** 开始拖拽 */\r\n        startDrag(): void;\r\n        /** 停止拖拽 */\r\n        stopDrag(): void;\r\n        /** 移除拖拽事件 */\r\n        removeDragEvent(): void;\r\n    }\r\n\r\n    export namespace Node {\r\n        /** 支持的拖拽事件 */\r\n        export class DragEvent {\r\n            /** 拖拽开始事件 */\r\n            static DRAG_START: string;\r\n            /** 拖拽移动事件 */\r\n            static DRAG_MOVE: string;\r\n            /** 拖拽结束事件 */\r\n            static DRAG_END: string;\r\n        }\r\n    }\r\n}"]}