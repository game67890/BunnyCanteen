{"version":3,"sources":["file:///F:/TON-Game/src/trunk/client/assets/scripts/tongame/manager/WebSocketManager.ts"],"names":["WebSocketManager","oops","TonGameMgr","PaymentMgr","UtilMgr","tips","socket","isKicked","removeHttpProtocol","url","replace","connectWebSocket","userId","http","server","isHttps","FinalURL","WebSocket","onopen","console","log","readyState","OPEN","send","JSON","stringify","type","onclose","setTimeout","UserId","onerror","error","onmessage","event","protocol","parse","data","dispatch","NotifyType","ProcessPay","updateCarrotCoin","carrotCoin","confirmTips","language","getLangByID","onDestroy","close","sendPing","WebSocketMgr"],"mappings":"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","sourcesContent":["import { oops } from \"../../../../extensions/oops-plugin-framework/assets/core/Oops\";\r\nimport { TonGameMgr } from \"./TonGameManager\";\r\nimport { PaymentMgr } from \"../payment/PaymentManager\";\r\nimport { UtilMgr } from \"../manager/UtilManager\";\r\nimport { tips } from \"../../framework/common/prompt/TipsManager\";\r\n\r\nexport class WebSocketManager {\r\n    private socket: WebSocket | null = null;\r\n    private isKicked : boolean = false;\r\n\r\n    // 使用正则表达式去掉 http:// 或 https://\r\n    removeHttpProtocol(url: string): string {\r\n        return url.replace(/^https?:\\/\\//, '');\r\n    }\r\n\r\n    connectWebSocket(userId: string) {\r\n        let url = oops.http.server + \"websocket\"\r\n        if (UtilMgr.isHttps(url))\r\n        {\r\n            let FinalURL = \"wss://\" + this.removeHttpProtocol(url);\r\n            this.socket = new WebSocket(FinalURL);\r\n        }\r\n        else\r\n        {\r\n            let FinalURL = \"ws://\" + this.removeHttpProtocol(url);\r\n            this.socket = new WebSocket(FinalURL);\r\n        }\r\n\r\n\r\n\r\n\r\n        // 在连接打开前设置自定义的 HTTP 头\r\n        this.socket.onopen = () => {\r\n            console.log(\"WebSocket connection opened\");\r\n            //oops.gui.toast(\"WebSocket connection opened\", true);\r\n            // 发送用户 ID 作为初始化的认证信息\r\n            if (this.socket.readyState === WebSocket.OPEN) {\r\n                this.socket.send(JSON.stringify({ type: \"init\", userId }));\r\n            }\r\n        };\r\n    \r\n        this.socket.onclose = () => {\r\n            console.log(\"WebSocket connection closed\");\r\n            //oops.gui.toast(\"WebSocket connection closed\", true);\r\n            setTimeout(() => {\r\n                if (!this.isKicked)\r\n                {\r\n                    this.connectWebSocket(TonGameMgr.UserId);\r\n                }\r\n            }, 5000);\r\n        };\r\n    \r\n        this.socket.onerror = (error) => {\r\n            console.error(\"WebSocket error:\", error);\r\n            //oops.gui.toast(\"WebSocket error\"+error, true);\r\n        };\r\n\r\n\r\n        this.socket.onmessage = (event) => {\r\n            let protocol = JSON.parse(event.data);\r\n            //oops.gui.toast(\"WebSocket message \"+protocol.NotifyType, true);\r\n            this.dispatch(protocol);\r\n        };\r\n    }\r\n\r\n    dispatch(protocol){\r\n        if (protocol.NotifyType == \"Charge_Success\") { //充值成功\r\n            PaymentMgr.ProcessPay(protocol);\r\n        }\r\n        else if (protocol.NotifyType == \"Invite_New\") { //邀请成功\r\n            TonGameMgr.updateCarrotCoin(protocol.carrotCoin);\r\n        }\r\n        else if (protocol.NotifyType == \"Invite_Rank\") { //被邀请人有人达到了新的段位\r\n            TonGameMgr.updateCarrotCoin(protocol.carrotCoin);\r\n        }\r\n        else if (protocol.NotifyType == \"Kick\") { //顶号\r\n            this.isKicked = true;\r\n            tips.confirmTips(\"\",oops.language.getLangByID(\"message_14\"), oops.language.getLangByID(\"stringres_009\"), false);\r\n        }\r\n        else if (protocol.NotifyType == \"RabbitCoin_Add\") { //修改萝卜币\r\n            TonGameMgr.updateCarrotCoin(protocol.carrotCoin);\r\n        }\r\n    }\r\n\r\n    onDestroy() {\r\n        //oops.gui.toast(\"WebSocket onDestroy\", true);\r\n        if (this.socket) {\r\n            this.socket.close();\r\n            this.socket = null;\r\n        }\r\n    }\r\n\r\n    sendPing()\r\n    {\r\n        if (this.socket && this.socket.readyState === WebSocket.OPEN) {\r\n            this.socket.send(\"ping\");\r\n        }\r\n    }\r\n}\r\n\r\nexport var WebSocketMgr = new WebSocketManager();"]}