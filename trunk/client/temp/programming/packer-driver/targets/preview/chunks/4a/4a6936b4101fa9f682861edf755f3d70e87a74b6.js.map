{"version":3,"sources":["file:///F:/TON-Game/src/trunk/client/extensions/oops-plugin-framework/assets/libs/gui/label/LabelTime.ts"],"names":["Label","_decorator","oops","EventMessage","TimeUtil","ccclass","property","menu","LabelTime","tooltip","backStartTime","dateDisable","result","onSecond","onComplete","replace","value","args","m","i","format","c","countDown","date","Math","floor","hours","minutes","seconds","zeroize","timeFormat","dataFormat","dayFormat","index","indexOf","substring","df","coverString","string","toString","setDateDisable","flag","setTime","second","timing_end","timing_start","setTimeStamp","timeStamp","secsBetween","timer","getServerTime","start","message","on","GAME_SHOW","onGameShow","GAME_HIDE","onGameHide","onDestroy","off","interval","getTime","onScheduleComplete","onScheduleSecond","node","schedule","unscheduleAllCallbacks"],"mappings":"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","sourcesContent":["import { Label, _decorator } from \"cc\";\r\nimport { oops } from \"../../../core/Oops\";\r\nimport { EventMessage } from \"../../../core/common/event/EventMessage\";\r\nimport { TimeUtil } from \"../../../core/utils/TimeUtils\";\r\n\r\nconst { ccclass, property, menu } = _decorator;\r\n\r\n@ccclass(\"LabelTime\")\r\n@menu('ui/label/LabelTime')\r\nexport default class LabelTime extends Label {\r\n    @property({\r\n        tooltip: \"到计时间总时间（单位秒）\"\r\n    })\r\n    countDown: number = 1000;\r\n\r\n    @property({\r\n        tooltip: \"天数数据格式化\"\r\n    })\r\n    dayFormat: string = \"{0} day\";\r\n\r\n    @property({\r\n        tooltip: \"时间格式化\"\r\n    })\r\n    timeFormat: string = \"{0}:{1}:{2}\";\r\n\r\n    @property({\r\n        tooltip: \"是否有00\"\r\n    })\r\n    zeroize: boolean = true;\r\n\r\n    private backStartTime: number = 0;      // 进入后台开始时间\r\n    private dateDisable!: boolean;          // 时间能否由天数显示\r\n    private result!: string;                // 时间结果字符串\r\n\r\n    /** 每秒触发事件 */\r\n    onSecond: Function = null!;\r\n    /** 倒计时完成事件 */\r\n    onComplete: Function = null!;\r\n\r\n    private replace(value: string, ...args: any): string {\r\n        return value.replace(/\\{(\\d+)\\}/g,\r\n            function (m, i) {\r\n                return args[i];\r\n            });\r\n    }\r\n\r\n    /** 格式化字符串 */\r\n    private format() {\r\n        let c: number = this.countDown;\r\n        let date: number = Math.floor(c / 86400);\r\n        c = c - date * 86400;\r\n        let hours: number = Math.floor(c / 3600);\r\n        c = c - hours * 3600;\r\n        let minutes: number = Math.floor(c / 60);\r\n        c = c - minutes * 60;\r\n        let seconds: number = c;\r\n\r\n        this.dateDisable = this.dateDisable || false;\r\n        if (date == 0 && hours == 0 && minutes == 0 && seconds == 0) {\r\n            if (this.zeroize) {\r\n                this.result = this.replace(this.timeFormat, \"00\", \"00\", \"00\");\r\n            }\r\n            else {\r\n                this.result = this.replace(this.timeFormat, \"0\", \"0\", \"0\");\r\n            }\r\n        }\r\n        else if (date > 0 && !this.dateDisable) {\r\n            let dataFormat = this.dayFormat;\r\n            let index = dataFormat.indexOf(\"{1}\");\r\n            if (hours == 0 && index > -1) {\r\n                dataFormat = dataFormat.substring(0, index - 1);\r\n            }\r\n            let df = dataFormat;\r\n            if (date > 1 && dataFormat.indexOf(\"days\") < 0) {\r\n                df = df.replace(\"day\", \"days\");\r\n            }\r\n            if (date < 2) {\r\n                df = df.replace(\"days\", \"day\");\r\n            }\r\n            this.result = this.replace(df, date, hours);                      // 如果天大于1，则显示 \"1 Day...\"\r\n        }\r\n        else {\r\n            hours += date * 24;\r\n            if (this.zeroize) {\r\n                this.result = this.replace(\r\n                    this.timeFormat,\r\n                    this.coverString(hours),\r\n                    this.coverString(minutes),\r\n                    this.coverString(seconds));                                            // 否则显示 \"01:12:24\"\r\n            }\r\n            else {\r\n                this.result = this.replace(\r\n                    this.timeFormat,\r\n                    hours,\r\n                    minutes,\r\n                    seconds);\r\n            }\r\n        }\r\n        this.string = this.result;\r\n    }\r\n\r\n    /** 个位数的时间数据将字符串补位 */\r\n    private coverString(value: number) {\r\n        if (value < 10)\r\n            return \"0\" + value;\r\n        return value.toString();\r\n    }\r\n\r\n    /** 设置时间能否由天数显示 */\r\n    setDateDisable(flag: boolean) {\r\n        this.dateDisable = flag;\r\n    }\r\n\r\n    /**\r\n     * 设置倒计时时间\r\n     * @param second        倒计时时间（单位秒）\r\n     */\r\n    setTime(second: number) {\r\n        this.countDown = second;                                             // 倒计时，初始化显示字符串\r\n        this.timing_end();\r\n        this.timing_start();\r\n        this.format();\r\n    }\r\n\r\n    /**\r\n     * 设置结束时间戳倒计时\r\n     * @param timeStamp     时间戳\r\n     */\r\n    setTimeStamp(timeStamp: number) {\r\n        this.countDown = TimeUtil.secsBetween(oops.timer.getServerTime(), timeStamp);\r\n        this.timing_end();\r\n        this.timing_start();\r\n        this.format();\r\n    }\r\n\r\n    start() {\r\n        oops.message.on(EventMessage.GAME_SHOW, this.onGameShow, this);\r\n        oops.message.on(EventMessage.GAME_HIDE, this.onGameHide, this);\r\n        this.timing_start();\r\n        this.format();\r\n    }\r\n\r\n    onDestroy() {\r\n        oops.message.off(EventMessage.GAME_SHOW, this.onGameShow, this);\r\n        oops.message.off(EventMessage.GAME_HIDE, this.onGameHide, this);\r\n    }\r\n\r\n    private onGameShow() {\r\n        const interval = Math.floor((oops.timer.getTime() - (this.backStartTime || oops.timer.getTime())) / 1000);\r\n        this.countDown -= interval;\r\n        if (this.countDown < 0) {\r\n            this.countDown = 0;\r\n            this.onScheduleComplete();\r\n        }\r\n    }\r\n\r\n    private onGameHide() {\r\n        this.backStartTime = oops.timer.getTime();\r\n    }\r\n\r\n    private onScheduleSecond() {\r\n        this.countDown--;\r\n        this.format();\r\n        if (this.onSecond) this.onSecond(this.node);\r\n\r\n        if (this.countDown == 0) {\r\n            this.onScheduleComplete();\r\n        }\r\n    }\r\n\r\n    private onScheduleComplete() {\r\n        this.timing_end();\r\n        this.format();\r\n        if (this.onComplete) this.onComplete(this.node);\r\n    }\r\n\r\n    /** 开始计时 */\r\n    private timing_start() {\r\n        this.schedule(this.onScheduleSecond, 1);\r\n    }\r\n\r\n    private timing_end() {\r\n        this.unscheduleAllCallbacks();\r\n    }\r\n}\r\n"]}