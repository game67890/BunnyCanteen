{"version":3,"sources":["file:///F:/TON-Game/src/trunk/client/extensions/oops-plugin-framework/assets/core/utils/ViewUtil.ts"],"names":["ViewUtil","Animation","AnimationClip","instantiate","Prefab","Size","UITransform","v3","resLoader","nodeTreeInfoLite","parent","obj","map","Map","items","children","i","length","_node","name","indexOf","set","findNodes","reg","nodes","ns","_name","test","push","calculateASpaceToBSpacePos","a","b","aPos","world","getComponent","convertToWorldSpaceAR","convertToNodeSpaceAR","calculateScreenPosToSpacePos","event","space","uil","getUILocation","worldPos","x","y","uniformScale","targetWidth","targetHeight","defaultWidth","defaultHeight","widthRatio","heightRatio","ratio","Math","floor","createPrefabNode","path","p","get","createPrefabNodeAsync","Promise","resolve","reject","prefab","loadAsync","node","addNodeAnimation","onlyOne","isDefaultClip","isValid","anim","addComponent","clip","getState","isPlaying","defaultClip","play","once","EventType","FINISHED","createState"],"mappings":"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","sourcesContent":["/*\r\n * @Author: dgflash\r\n * @Date: 2021-08-16 09:34:56\r\n * @LastEditors: dgflash\r\n * @LastEditTime: 2023-01-19 14:52:12\r\n */\r\nimport {Animation, AnimationClip, EventTouch, instantiate, Node, Prefab, Size, UITransform, v3, Vec3} from \"cc\";\r\nimport {resLoader} from \"../common/loader/ResLoader\";\r\n\r\n/** 显示对象工具 */\r\nexport class ViewUtil {\r\n    /**\r\n     * 把Node当前的节点树结构根据Node命名转成一个js对象,重名的组件会覆盖，\r\n     * Node的name不应该包含空格键，否则将跳过\r\n     * @param parent 被遍历的Node组件\r\n     * @param obj    绑定的js对象 (可选)\r\n     */\r\n    static nodeTreeInfoLite(parent: Node, obj?: Map<string, Node>): Map<string, Node> | null {\r\n        let map: Map<string, Node> = obj || new Map();\r\n        let items = parent.children;\r\n        for (let i = 0; i < items.length; i++) {\r\n            let _node = items[i];\r\n            if (_node.name.indexOf(\" \") < 0) {\r\n                map.set(_node.name, _node);\r\n            }\r\n            ViewUtil.nodeTreeInfoLite(_node, map);\r\n        }\r\n        return map;\r\n    }\r\n\r\n    /**\r\n     * 正则搜索节点名字,符合条件的节点将会返回\r\n     * @param reg     正则表达式\r\n     * @param parent  要搜索的父节点\r\n     * @param nodes   返回的数组（可选）\r\n     */\r\n    static findNodes(reg: RegExp, parent: Node, nodes?: Array<Node>): Array<Node> {\r\n        let ns: Array<Node> = nodes || [];\r\n        let items = parent.children;\r\n        for (let i = 0; i < items.length; i++) {\r\n            let _name: string = items[i].name;\r\n            if (reg.test(_name)) {\r\n                ns.push(items[i]);\r\n            }\r\n            ViewUtil.findNodes(reg, items[i], ns);\r\n        }\r\n        return ns;\r\n    };\r\n\r\n    /**\r\n     * 节点之间坐标互转\r\n     * @param a         A节点\r\n     * @param b         B节点\r\n     * @param aPos      A节点空间中的相对位置\r\n     */\r\n    static calculateASpaceToBSpacePos(a: Node, b: Node, aPos: Vec3): Vec3 {\r\n        const world: Vec3 = a.getComponent(UITransform)!.convertToWorldSpaceAR(aPos);\r\n        return b.getComponent(UITransform)!.convertToNodeSpaceAR(world);\r\n    }\r\n\r\n    /**\r\n     * 屏幕转空间坐标\r\n     * @param event 触摸事件\r\n     * @param space 转到此节点的坐标空间\r\n     */\r\n    static calculateScreenPosToSpacePos(event: EventTouch, space: Node): Vec3 {\r\n        const uil = event.getUILocation();\r\n        const worldPos: Vec3 = v3(uil.x, uil.y);\r\n        return space.getComponent(UITransform)!.convertToNodeSpaceAR(worldPos);\r\n    }\r\n\r\n    /**\r\n     * 显示对象等比缩放\r\n     * @param targetWidth       目标宽\r\n     * @param targetHeight      目标高\r\n     * @param defaultWidth      默认宽\r\n     * @param defaultHeight     默认高\r\n     */\r\n    static uniformScale(targetWidth: number, targetHeight: number, defaultWidth: number, defaultHeight: number) {\r\n        const widthRatio = defaultWidth / targetWidth;\r\n        const heightRatio = defaultHeight / targetHeight;\r\n        let ratio;\r\n        widthRatio < heightRatio ? ratio = widthRatio : ratio = heightRatio;\r\n        return new Size(Math.floor(targetWidth * ratio), Math.floor(targetHeight * ratio));\r\n    }\r\n\r\n    /**\r\n     * 从资源缓存中找到预制资源名并创建一个显示对象（建议使用GameComponent里的同名方法，能自动管理内存施放）\r\n     * @param path 资源路径\r\n     */\r\n    static createPrefabNode(path: string): Node {\r\n        const p: Prefab = resLoader.get(path, Prefab)!;\r\n        return instantiate(p);\r\n    }\r\n\r\n    /**\r\n     * 加载预制并创建预制节点（建议使用GameComponent里的同名方法，能自动管理内存施放）\r\n     * @param path 资源路径\r\n     */\r\n    static createPrefabNodeAsync(path: string): Promise<Node> {\r\n        return new Promise(async (resolve, reject) => {\r\n            const prefab = await resLoader.loadAsync(path, Prefab);\r\n            if (prefab) {\r\n                const node = this.createPrefabNode(path);\r\n                resolve(node);\r\n            }\r\n            else {\r\n                resolve(null!);\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * 添加节点动画\r\n     * @param path              资源路径\r\n     * @param node              目标节点\r\n     * @param onlyOne           是否唯一\r\n     * @param isDefaultClip     是否播放默认动画剪辑\r\n     */\r\n    static addNodeAnimation(path: string, node: Node, onlyOne: boolean = true, isDefaultClip: boolean = false) {\r\n        if (!node || !node.isValid) {\r\n            return;\r\n        }\r\n\r\n        let anim = node.getComponent(Animation);\r\n        if (anim == null) {\r\n            anim = node.addComponent(Animation);\r\n        }\r\n\r\n        const clip = resLoader.get(path, AnimationClip) as AnimationClip;\r\n        if (!clip) {\r\n            return;\r\n        }\r\n\r\n        if (onlyOne && anim.getState(clip.name) && anim.getState(clip.name).isPlaying) {\r\n            return;\r\n        }\r\n\r\n        if (isDefaultClip) {\r\n            anim.defaultClip = clip;\r\n            anim.play();\r\n            return;\r\n        }\r\n\r\n        // 播放完成后恢复播放默认动画\r\n        anim.once(Animation.EventType.FINISHED, () => {\r\n            if (anim!.defaultClip) {\r\n                anim!.play();\r\n            }\r\n        }, this);\r\n\r\n        if (anim.getState(clip.name)) {\r\n            anim.play(clip.name);\r\n            return\r\n        }\r\n        anim.createState(clip, clip!.name);\r\n        anim.play(clip!.name);\r\n    }\r\n}"]}